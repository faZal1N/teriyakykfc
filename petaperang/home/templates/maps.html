{% extends "people.html" %}
{% load static %}

{% block content %}
    <script src="{% static 'home/js/map.js' %}" type="text/javascript"></script>
    <style>
        body {
           background:url({% static 'home/images/tild3163-3764-4937-a239-343032626332__1670825509_3-27.jpg'%}) no-repeat center center fixed  #fff5e4;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        }
        .ymaps-2-1-79-map {
            min-height:200px;
        }

    </style>

    <script>
        $(function() {

            function items_search(searchtext){
                return $.ajax({
                    method: "GET",
                    data: {term: searchtext},
                    url: "search/",
                    async: false,
                });
            }

            $('input[name=search_engine]').bind({
                keyup: function(e){
                    console.log (e.target.value);
                    $.when(items_search(e.target.value)).done((data) => {
                        console.log (data);
                        search_to_window(data);
                    });
                }
            });

            function search_to_window(data){
                $('#items_div').empty();
                for(var item of data){
                     $('#items_div').append(
                         '<div class="t403__container-table t-width_12 shadowcontent" style="margin: 10px; background-color: #fff5e4; opacity: 0.95;">'+
                            '<a class="t403__link" href="'+item.slug+'">'+
                                '<div class="t403__tcol2 t403__tcol2_flipped" >'+
                                        '<div class="t403__title t-title t-title_xxs" style="padding:20px;">'+item.name+'</div>'+
                                        '<div class="t403__text t-text t-text_md" style="padding:20px;">'+item.begin+'-'+item.end+'</div>'+
                                        '<div class="t403__descr t-descr t-descr_sm" style="padding:20px;">'+item.description+'</div>'+
                                '</div>'+
                            '</a>'+
                            '<div class="t403__tcol1" id=map'+item.id+'></div>'+
                         '</div>'
                     );
                     insert_map (item);
                };
            };

            function insert_map (item) {
                var myMap = new ymaps.Map("map"+item.id, {
                    center: [item.x, item.y],
                    zoom: item.zoom,
                    controls: [], // Убираем все элементы управления
                    size: (100, 100),
                }, {
                    searchControlProvider: 'yandex#search'
                });
                myMap.geoObjects.add(new ymaps.Placemark([item.x, item.y], {
                    iconCaption: item.name,
                    balloonContent: (item.name + '<br>' + item.description + '<br>' + item.begin + '-' + item.end),
                }, {
                    preset: 'islands#dotIcon',
                    iconColor: '#735184'
                }))
                var kmls = ymaps.geoXml.load(item.kml);
                kmls.then(function(res) { // Обработка полученного асинхронно ответа.
                    myMap.geoObjects.add(res.geoObjects);     // Добавление объектов на карту.
                });
            }
        });

    </script>

    <div class="content t-container " style="min-height:100vh;">
        <div class="content t-container" style="padding-top:90px;padding-bottom:50px;">
            <input type="text" name="search_engine"
                id="input_4914859299010"
                class="t-input js-tilda-rule"
                placeholder="Поиск события на карте"
                style="color:#000000;border:1px solid #000000;">
        </div>
        <div class="t403 footer"  id="items_div" >
        </div>
    </div>
{% endblock %}